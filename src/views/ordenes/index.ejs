<% title = title || 'Órdenes' %>
<%
  const currentStateFilter = typeof stateFilter === 'string' ? stateFilter : 'all';
  const stateQueryValue = currentStateFilter === 'active' ? 'activa' : currentStateFilter === 'inactive' ? 'inhabilitada' : '';
  const safePage = Number(page) > 0 ? Number(page) : 1;
  const safePages = Number(pages) > 0 ? Number(pages) : 1;
  const safeLimit = Number(limit) > 0 ? Number(limit) : 10;
  const safeTotal = Number(total) >= 0 ? Number(total) : 0;
  const itemCount = Array.isArray(items) ? items.length : 0;
  const startIndex = safeTotal === 0 || itemCount === 0 ? 0 : (safePage - 1) * safeLimit + 1;
  const endIndex = safeTotal === 0 || itemCount === 0 ? 0 : Math.min(safeTotal, startIndex + itemCount - 1);
  let pageSizeOptionsResolved = Array.isArray(pageSizeOptions) && pageSizeOptions.length ? [...pageSizeOptions] : [5, 10, 15, 20];
  const pageSizeSet = new Set(pageSizeOptionsResolved);
  if (!pageSizeSet.has(safeLimit)) {
    pageSizeOptionsResolved.push(safeLimit);
  }
  pageSizeOptionsResolved = pageSizeOptionsResolved
    .map((value) => Number(value))
    .filter((value) => Number.isFinite(value) && value > 0)
    .sort((a, b) => a - b);
  const baseQueryParams = {};
  if (stateQueryValue) baseQueryParams.state = stateQueryValue;
  baseQueryParams.limit = safeLimit;
  baseQueryParams.page = safePage;
  const buildQuery = (overrides = {}) => {
    const params = { ...baseQueryParams };
    Object.entries(overrides || {}).forEach(([key, value]) => {
      if (value === null || value === undefined || value === '' || (typeof value === 'number' && !Number.isFinite(value))) {
        delete params[key];
      } else {
        params[key] = value;
      }
    });
    const entries = Object.entries(params)
      .filter(([, value]) => value !== undefined && value !== null && value !== '')
      .map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(String(value))}`);
    return entries.length ? `?${entries.join('&')}` : '';
  };
%>

<% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-error mb-4 text-sm">
    <span><%= error %></span>
  </div>
<% } %>

<div class="flex items-center justify-between mb-2">
  <div>
    <h1 class="text-2xl font-bold">Órdenes</h1>
    <p class="opacity-70 text-sm">Listado y gestión de órdenes</p>
  </div>
  <div class="flex flex-wrap gap-2 justify-end">
    <a class="btn btn-outline btn-sm" href="/ordenes/calculadora">Calculadora</a>
    <a class="btn btn-ghost btn-sm" href="/ordenes/template">Descargar plantilla</a>
    <button id="btn-import-orders" class="btn btn-secondary btn-sm">Importar Excel</button>
    <button id="btn-add-order" class="btn btn-primary btn-sm">
      Agregar orden
    </button>
  </div>

</div>

<div id="orders-success-banner" class="alert alert-success hidden mb-4 text-sm"></div>

<!-- Tabla de órdenes -->
<div class="card bg-base-200 shadow">
  <div class="card-body">
    <div class="flex items-center gap-2 text-xs mb-3">
      <span class="uppercase tracking-wide opacity-60">Estado:</span>
      <div class="join">
        <a class="btn btn-xs join-item <%= currentStateFilter==='all' ? 'btn-primary' : 'btn-ghost' %>" href="/ordenes<%= buildQuery({ state: '', page: 1 }) %>">Todas</a>
        <a class="btn btn-xs join-item <%= currentStateFilter==='active' ? 'btn-primary' : 'btn-ghost' %>" href="/ordenes<%= buildQuery({ state: 'activa', page: 1 }) %>">Activas</a>
        <a class="btn btn-xs join-item <%= currentStateFilter==='inactive' ? 'btn-primary' : 'btn-ghost' %>" href="/ordenes<%= buildQuery({ state: 'inhabilitada', page: 1 }) %>">Inhabilitadas</a>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="table table-zebra" data-orders-table>
        <thead>
          <tr>
            <th># Orden</th>
            <th>Código producto</th>
            <th>Modelo sugerido</th>
            <th>Cantidad sugerida</th>
            <th>Cantidad</th>
            <th>Ciudad destino</th>
            <th>Ubicación destino</th>
            <th>Cliente</th>
            <th>Estado</th>
            <th>Fecha generación</th>
            <th class="text-right">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% if ((items||[]).length === 0) { %>
            <tr>
              <td colspan="11" class="text-center opacity-60">
                <% if (currentStateFilter === 'inactive') { %>
                  No hay órdenes inhabilitadas.
                <% } else if (currentStateFilter === 'active') { %>
                  No hay órdenes activas.
                <% } else { %>
                  No hay órdenes por ahora.
                <% } %>
              </td>
            </tr>
          <% } else { %>
            <% items.forEach(o => { %>
              <tr>
                <td><%= o.numero_orden || '-' %></td>
                <td><%= o.codigo_producto || '-' %></td>
                <td><%= o.modelo_sugerido_nombre || '-' %></td>
                <td><%= o.cantidad_modelos ?? '-' %></td>
                <td><%= o.cantidad ?? '-' %></td>
                <td><%= o.ciudad_destino || '-' %></td>
                <td><%= o.ubicacion_destino || '-' %></td>
                <td><%= o.cliente || '-' %></td>
                <td>
                  <% const ordenHabilitada = o.habilitada !== false; %>
                  <% const estadoActivo = ordenHabilitada && o.estado_orden !== false; %>
                  <span class="badge badge-sm <%= estadoActivo ? 'badge-primary badge-outline' : 'badge-error badge-outline' %>">
                    <%= estadoActivo ? 'Activa' : 'Inhabilitada' %>
                  </span>
                  <% if (!ordenHabilitada) { %>
                    <span class="badge badge-xs badge-outline badge-warning ml-1">Manual</span>
                  <% } %>
                </td>
                <td><%= o.fecha_generacion ? new Date(o.fecha_generacion).toLocaleString() : '-' %></td>
                <td class="text-right">
                  <div class="join join-horizontal justify-end">
        <button class="btn btn-xs btn-ghost join-item" data-edit
          data-id="<%= o.id %>"
          data-numero="<%= o.numero_orden||'' %>"
          data-codigo="<%= o.codigo_producto||'' %>"
          data-cantidad="<%= o.cantidad ?? '' %>"
          data-ciudad="<%= o.ciudad_destino||'' %>"
          data-ubicacion="<%= o.ubicacion_destino||'' %>"
          data-cliente="<%= o.cliente||'' %>">Editar</button>
                    <button class="btn btn-xs <%= estadoActivo ? 'btn-warning btn-outline' : 'btn-success btn-outline' %> join-item" data-toggle-order data-id="<%= o.id %>" data-numero="<%= o.numero_orden||'-' %>" data-enabled="<%= estadoActivo ? '1' : '0' %>">
                      <%= estadoActivo ? 'Inhabilitar' : 'Reactivar' %>
                    </button>
                    <button class="btn btn-xs btn-error btn-outline join-item" data-delete data-id="<%= o.id %>" data-numero="<%= o.numero_orden||'-' %>">Eliminar</button>
                  </div>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="mt-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between text-sm">
  <div>
    <span class="opacity-70">Mostrando</span>
    <span class="font-semibold">
      <% if (safeTotal === 0 || itemCount === 0) { %>
        0
      <% } else { %>
        <%= startIndex %>-<%= endIndex %>
      <% } %>
    </span>
    <span class="opacity-70">de</span>
    <span class="font-semibold"><%= safeTotal %></span>
  </div>
  <div class="flex flex-col items-start gap-3 md:flex-row md:items-center md:gap-6">
    <form id="orders-limit-form" method="get" action="/ordenes" class="flex items-center gap-2">
      <% if (stateQueryValue) { %>
        <input type="hidden" name="state" value="<%= stateQueryValue %>" />
      <% } %>
      <input type="hidden" name="page" value="1" />
      <label for="orders-limit-select" class="label text-xs opacity-70 p-0">Resultados por página:</label>
      <select id="orders-limit-select" name="limit" class="select select-xs select-bordered w-auto">
        <% pageSizeOptionsResolved.forEach((opt) => { %>
          <option value="<%= opt %>" <%= opt === safeLimit ? 'selected' : '' %>><%= opt %></option>
        <% }) %>
      </select>
    </form>
    <div class="join">
      <% if (safePage > 1) { %>
        <a class="btn btn-xs join-item" href="/ordenes<%= buildQuery({ page: safePage - 1 }) %>">Anterior</a>
      <% } else { %>
        <span class="btn btn-xs join-item btn-disabled opacity-60">Anterior</span>
      <% } %>
      <span class="btn btn-xs join-item btn-disabled">Página <%= safePage %> de <%= safePages %></span>
      <% if (safePage < safePages) { %>
        <a class="btn btn-xs join-item" href="/ordenes<%= buildQuery({ page: safePage + 1 }) %>">Siguiente</a>
      <% } else { %>
        <span class="btn btn-xs join-item btn-disabled opacity-60">Siguiente</span>
      <% } %>
    </div>
  </div>
</div>

<!-- Modal importar órdenes -->
<dialog id="modal-import-orders" class="modal">
  <div class="modal-box w-11/12 max-w-2xl sm:w-full">
    <h3 class="font-bold text-lg mb-3">Importar órdenes desde Excel</h3>
    <div class="alert alert-info text-sm">
      <span>Usa la plantilla oficial para mantener el orden de columnas. Las filas vacías se ignoran y las órdenes existentes se actualizan.</span>
    </div>
    <form id="form-import-orders" class="space-y-4" enctype="multipart/form-data">
      <div class="form-control">
        <label class="label"><span class="label-text">Archivo Excel (.xlsx)</span></label>
        <input type="file" name="file" accept=".xlsx" class="file-input file-input-bordered file-input-sm w-full" required />
      </div>
      <div id="import-status" class="hidden text-sm"></div>
      <div id="import-errors" class="hidden text-sm text-error"></div>
      <div class="flex justify-end gap-2 pt-2">
        <button type="button" class="btn btn-sm" data-close>Cancelar</button>
        <button id="import-submit" class="btn btn-sm btn-primary" type="submit">
          <span id="import-submit-text">Procesar</span>
          <span id="import-spinner" class="loading loading-spinner loading-xs hidden"></span>
        </button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<!-- Modal crear orden -->
<dialog id="modal-add-order" class="modal">
  <div class="modal-box w-11/12 max-w-3xl sm:w-full">
    <h3 class="font-bold text-lg mb-2">Nueva orden</h3>
    <form class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4" action="/ordenes/create" method="post">
      <div class="form-control">
        <label class="label"><span class="label-text">Número de orden</span></label>
        <input name="numero_orden" type="text" class="input input-sm input-bordered" required />
      </div>
      <div class="form-control">
        <label class="label"><span class="label-text">Código producto</span></label>
        <input name="codigo_producto" type="text" class="input input-sm input-bordered" />
      </div>
      <div class="form-control">
        <label class="label"><span class="label-text">Cantidad</span></label>
        <input name="cantidad" type="number" min="1" class="input input-sm input-bordered" />
      </div>
      <div class="form-control">
        <label class="label"><span class="label-text">Ciudad destino</span></label>
        <input name="ciudad_destino" type="text" class="input input-sm input-bordered" />
      </div>
      <div class="form-control">
        <label class="label"><span class="label-text">Ubicación destino</span></label>
        <input name="ubicacion_destino" type="text" class="input input-sm input-bordered" />
      </div>
      <div class="form-control">
        <label class="label"><span class="label-text">Cliente</span></label>
        <input name="cliente" type="text" class="input input-sm input-bordered" />
      </div>
      <input type="hidden" name="clientTzOffset" value="" />
      <input type="hidden" name="clientLocalNow" value="" />
      <div class="md:col-span-3 flex flex-col sm:flex-row items-stretch sm:items-end justify-end gap-2 mt-2">
        <button type="button" class="btn btn-sm sm:btn-md" data-close>Cancelar</button>
        <button class="btn btn-sm sm:btn-md btn-primary">Agregar</button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<!-- Modal editar orden -->
<dialog id="modal-edit-order" class="modal">
  <div class="modal-box w-11/12 max-w-3xl sm:w-full">
    <h3 class="font-bold text-lg mb-2">Editar orden</h3>
    <form id="form-edit-order" class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4" action="/ordenes/update" method="post">
      <input type="hidden" name="id" />
      <div class="form-control">
        <label class="label"><span class="label-text">Número de orden</span></label>
        <input name="numero_orden" type="text" class="input input-sm input-bordered" required />
      </div>
      <div class="form-control">
        <label class="label"><span class="label-text">Código producto</span></label>
        <input name="codigo_producto" type="text" class="input input-sm input-bordered" />
      </div>
      <div class="form-control">
        <label class="label"><span class="label-text">Cantidad</span></label>
        <input name="cantidad" type="number" min="1" class="input input-sm input-bordered" />
      </div>
      <div class="form-control">
        <label class="label"><span class="label-text">Ciudad destino</span></label>
        <input name="ciudad_destino" type="text" class="input input-sm input-bordered" />
      </div>
      <div class="form-control">
        <label class="label"><span class="label-text">Ubicación destino</span></label>
        <input name="ubicacion_destino" type="text" class="input input-sm input-bordered" />
      </div>
      <div class="form-control">
        <label class="label"><span class="label-text">Cliente</span></label>
        <input name="cliente" type="text" class="input input-sm input-bordered" />
      </div>
      <div class="md:col-span-3 flex flex-col sm:flex-row items-stretch sm:items-end justify-end gap-2 mt-2">
        <button type="button" class="btn btn-sm sm:btn-md" data-close>Cancelar</button>
        <button class="btn btn-sm sm:btn-md btn-primary">Guardar</button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<!-- Modal eliminar orden -->
<dialog id="modal-delete-order" class="modal">
  <div class="modal-box max-w-md">
    <h3 class="font-bold text-lg">Eliminar orden</h3>
    <p class="py-2">¿Seguro que deseas eliminar la orden <span id="del-order-label" class="font-mono"></span>? Esta acción no se puede deshacer.</p>
    <form id="form-delete-order" action="/ordenes/delete" method="post" class="flex gap-2 justify-end pt-2">
      <input type="hidden" name="id" />
      <button type="button" class="btn" data-close>Cancelar</button>
      <button class="btn btn-error">Eliminar</button>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
<script src="/static/js/ordenes.js?v=<%= assetVersion %>" defer></script>
