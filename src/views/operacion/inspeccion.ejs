<% title = title || 'Operación · Inspección' %>
<div class="mb-8 space-y-6">
  <h1 class="text-2xl font-bold">Inspección</h1>

  <div class="space-y-6">
    <!-- Listado de cajas -->
    <div class="rounded-xl border border-base-300/50 bg-base-200/5 p-5">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <span id="insp-spin" class="loading loading-spinner loading-xs hidden"></span>
          <span class="text-sm opacity-60">Piezas en Inspección.</span>
        </div>
        <button id="insp-btn-add" type="button" class="btn btn-primary btn-sm">Agregar piezas a Inspección</button>
      </div>
      <div id="insp-caja-grid" class="grid gap-4 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4"></div>
    </div>

    <!-- Panel de trabajo: identificar caja y checklist de 6 TICs -->
  <div class="rounded-xl border border-base-300/50 bg-base-200/5 p-5 flex flex-col gap-4">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <h2 class="text-sm font-semibold tracking-wide uppercase opacity-80">Inspección individual</h2>
        <div class="join join-sm self-start sm:self-end">
          <button id="insp-mode-individual" type="button" class="btn btn-xs join-item btn-primary">Modo individual</button>
          <button id="insp-mode-bulk" type="button" class="btn btn-xs join-item btn-ghost">Modo masivo</button>
        </div>
      </div>
      <div id="insp-single-section" class="space-y-3">
        <div class="form-control">
          <label class="label py-1"><span class="label-text text-xs opacity-70">Escanea un RFID (24 caracteres)</span></label>
          <input id="insp-scan" type="text" maxlength="24" class="input input-sm input-bordered font-mono" placeholder="RFID 24" autocomplete="off" />
        </div>
        <div class="flex gap-2">
          <button id="insp-scan-btn" class="btn btn-sm btn-primary flex-1">Buscar pieza</button>
          <button id="insp-scan-clear" class="btn btn-sm">Limpiar</button>
        </div>
        <div id="insp-scan-msg" class="text-xs min-h-[18px] font-mono opacity-80"></div>
      </div>

      <div id="insp-bulk-section" class="hidden space-y-3">
        <div class="form-control">
          <label class="label py-1"><span class="label-text text-xs opacity-70">Escanea RFIDs consecutivos (24 caracteres). Cada lectura se agrega automáticamente.</span></label>
          <input id="insp-bulk-input" type="text" class="input input-sm input-bordered font-mono" placeholder="Listo para escanear en cola" autocomplete="off" />
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <button id="insp-bulk-next" class="btn btn-sm btn-accent">Identificar siguiente</button>
          <button id="insp-bulk-clear" class="btn btn-sm">Limpiar cola</button>
        </div>
        <div id="insp-bulk-msg" class="text-xs min-h-[18px] font-mono opacity-80"></div>
        <div class="border border-dashed border-base-300 rounded-lg p-3 bg-base-300/10 space-y-2 max-h-48 overflow-y-auto" id="insp-bulk-list">
          <div class="text-xs opacity-60">Sin piezas en cola.</div>
        </div>
      </div>

  <div id="insp-caja-panel" class="hidden space-y-3">
        <div class="text-xs opacity-60 uppercase tracking-wide">Pieza detectada</div>
        <div class="border rounded-lg p-3 bg-base-300/10 space-y-2">
          <div class="flex items-center justify-between text-[11px] font-mono opacity-70"><span>Pieza</span><span id="insp-caja-lote">—</span></div>
          <div class="text-[11px] font-mono opacity-70"><span>Conteo TICs:</span> <span id="insp-caja-tic-count">0</span>/6</div>
        </div>
        <!-- Componentes identificados (TIC/VIP/CUBE) mostrados al escanear cualquier RFID -->
        <div class="space-y-2">
          <div class="text-xs opacity-80">Componentes identificados:</div>
          <div id="insp-caja-comps" class="flex flex-wrap gap-1"></div>
        </div>

  <!-- Área del checklist de TICs y componentes VIP/CUBE: sólo visible cuando la caja está en Inspección -->
        <div id="insp-checklist-area" class="space-y-3">
          <div class="flex items-center justify-end gap-2">
            <button id="insp-check-all" type="button" class="btn btn-ghost btn-xs">Marcar todo</button>
            <button id="insp-uncheck-all" type="button" class="btn btn-ghost btn-xs">Limpiar checks</button>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <div class="col-span-3">
              <label class="label py-1"><span class="label-text text-xs opacity-70">Escanea una TIC (24 caracteres) para habilitar su checklist</span></label>
              <input id="insp-tic-scan" type="text" maxlength="24" class="input input-sm input-bordered font-mono w-full" placeholder="RFID TIC" autocomplete="off" />
            </div>
            <button id="insp-tic-scan-btn" class="btn btn-sm btn-primary">Buscar TIC</button>
            <button id="insp-tic-scan-clear" class="btn btn-sm">Limpiar</button>
            <div id="insp-tic-msg" class="text-xs min-h-[18px] font-mono opacity-80 col-span-3"></div>
          </div>

          <div class="text-xs opacity-80">Escanea cada TIC y marca el checklist:</div>
          <div id="insp-tic-list" class="space-y-2"></div>

          <div class="divider my-2"></div>
          <div class="text-xs opacity-80">Componentes vinculados (VIP / CUBE):</div>
          <div id="insp-comp-list" class="space-y-2"></div>

          <button id="insp-complete" class="btn btn-sm btn-success w-full" disabled>Finalizar y devolver a Bodega</button>
        </div>
      </div>
    </div>
  </div>
  <script src="/static/js/location-selector.js?v=<%= assetVersion %>" defer></script>
  <script src="/static/js/inspeccion.js?v=<%= assetVersion %>" defer></script>
</div>

<!-- Modal Agregar a Inspección (scan + cronómetro obligatorio) -->
<dialog id="insp-modal-add" class="modal">
  <div class="modal-box max-w-lg">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
    </form>
    <h3 class="font-bold text-lg mb-2">Agregar piezas a Inspección</h3>
      <p class="text-xs opacity-70 mb-4">Escanea múltiples RFIDs de piezas en <strong>En bodega · Pendiente a Inspección</strong>. Se estimará automáticamente cuántas unidades se liberarán en cuanto identifiques alguna pieza de cada conjunto.</p>
    <label class="input input-bordered flex items-center gap-2 w-full mb-2">
      <span class="opacity-60 text-xs">RFID</span>
      <input id="insp-add-scan" type="text" class="grow font-mono" maxlength="24" autocomplete="off" placeholder="Listo para escanear..." />
    </label>
    <p class="text-[11px] opacity-70 mb-3">Presiona Enter después de cada lectura o utiliza un lector que envíe Enter automáticamente.</p>
    <div class="space-y-2 mb-4">
      <div class="text-xs opacity-80">Conteo acumulado</div>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
        <div class="border rounded-lg p-3 bg-base-300/10 space-y-1">
          <div class="text-[10px] uppercase opacity-70 tracking-wide">TIC</div>
          <div id="insp-add-count-tic" class="space-y-1">
            <div class="text-2xl font-semibold">0</div>
            <div class="text-[11px] opacity-60">Sin piezas</div>
          </div>
        </div>
        <div class="border rounded-lg p-3 bg-base-300/10 space-y-1">
          <div class="text-[10px] uppercase opacity-70 tracking-wide">VIP</div>
          <div id="insp-add-count-vip" class="space-y-1">
            <div class="text-2xl font-semibold">0</div>
            <div class="text-[11px] opacity-60">Sin piezas</div>
          </div>
        </div>
        <div class="border rounded-lg p-3 bg-base-300/10 space-y-1">
          <div class="text-[10px] uppercase opacity-70 tracking-wide">CUBE</div>
          <div id="insp-add-count-cube" class="space-y-1">
            <div class="text-2xl font-semibold">0</div>
            <div class="text-[11px] opacity-60">Sin piezas</div>
          </div>
        </div>
        <div class="border rounded-lg p-3 bg-base-300/10 space-y-1">
          <div class="text-[10px] uppercase opacity-70 tracking-wide">Cajas estimadas</div>
          <div id="insp-add-count-boxes" class="text-2xl font-semibold">0</div>
        </div>
      </div>
    </div>
    <div class="space-y-2 mb-4">
      <div class="text-xs opacity-80 flex items-center justify-between">
        <span>Piezas escaneadas</span>
        <span class="text-[10px] opacity-60">Haz clic en ✕ para quitar</span>
      </div>
      <div id="insp-add-items" class="border border-dashed border-base-300 rounded-lg p-3 bg-base-300/5 min-h-[72px] max-h-48 overflow-y-auto text-xs"></div>
    </div>
    <div class="grid grid-cols-2 gap-3 mb-3">
      <label class="form-control">
        <span class="label-text text-xs opacity-70">Horas</span>
        <input id="insp-add-hours" type="number" min="0" class="input input-sm input-bordered" placeholder="0" />
      </label>
      <label class="form-control">
        <span class="label-text text-xs opacity-70">Minutos</span>
        <input id="insp-add-mins" type="number" min="0" class="input input-sm input-bordered" placeholder="0" />
      </label>
    </div>
    <div class="grid gap-2 mb-3 text-xs">
      <label class="form-control gap-1">
        <span class="label-text text-[11px] opacity-70">Zona destino (opcional)</span>
        <select id="insp-add-zona" class="select select-sm select-bordered"></select>
      </label>
      <label class="form-control gap-1">
        <span class="label-text text-[11px] opacity-70">Sección destino (opcional)</span>
        <select id="insp-add-seccion" class="select select-sm select-bordered" disabled>
          <option value="">Sin sección</option>
        </select>
      </label>
      <p id="insp-add-location-hint" class="text-[11px] opacity-70 min-h-[16px]"></p>
    </div>
    <div class="flex items-center justify-between gap-4 mt-2">
      <button type="button" id="insp-add-clear" class="btn btn-ghost btn-xs">Limpiar lista</button>
      <div class="flex items-center gap-3">
        <span id="insp-add-msg" class="text-xs opacity-70"></span>
        <button id="insp-add-confirm" class="btn btn-primary btn-sm" disabled>Agregar</button>
      </div>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<!-- Modal: Inhabilitar TIC (Registrar novedad) -->
<dialog id="insp-nov-modal" class="modal">
  <div class="modal-box max-w-md">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
    </form>
    <h3 class="font-bold text-lg mb-2">Inhabilitar TIC</h3>
    <div class="text-xs opacity-70 mb-2">RFID:</div>
    <div id="insp-nov-rfid" class="font-mono text-xs mb-3">—</div>
    <div class="grid grid-cols-2 gap-3">
      <label class="form-control">
        <span class="label-text text-xs opacity-70">Tipo</span>
        <select id="insp-nov-tipo" class="select select-sm select-bordered">
          <option value="fisico">Físico</option>
          <option value="funcional">Funcional</option>
          <option value="contaminacion">Contaminación</option>
          <option value="faltante">Faltante</option>
          <option value="otro" selected>Otro</option>
        </select>
      </label>
      <label class="form-control">
        <span class="label-text text-xs opacity-70">Severidad (1-5)</span>
        <input id="insp-nov-severidad" type="number" min="1" max="5" value="3" class="input input-sm input-bordered" />
      </label>
    </div>
    <label class="form-control mt-3">
      <span class="label-text text-xs opacity-70">Motivo (obligatorio)</span>
      <input id="insp-nov-motivo" type="text" class="input input-sm input-bordered" placeholder="Resumen corto" />
    </label>
    <label class="form-control mt-2">
      <span class="label-text text-xs opacity-70">Descripción</span>
      <textarea id="insp-nov-desc" rows="3" class="textarea textarea-sm textarea-bordered" placeholder="Detalle opcional"></textarea>
    </label>
    <div class="form-control mt-2">
      <label class="label cursor-pointer justify-start gap-2">
        <input id="insp-nov-inhabilita" type="checkbox" class="checkbox checkbox-error checkbox-sm" checked />
        <span class="label-text text-xs">Marcar pieza como Inhabilitada</span>
      </label>
    </div>
    <div class="flex items-center justify-between mt-3">
      <span id="insp-nov-msg" class="text-xs opacity-70"></span>
      <button id="insp-nov-confirm" class="btn btn-error btn-sm">Registrar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

