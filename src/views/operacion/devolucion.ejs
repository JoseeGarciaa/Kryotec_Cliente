<% title = title || 'Operación · Devolución' %>
<div class="mb-8">
  <h1 class="text-2xl font-bold mb-6">Devolución</h1>
  <div class="grid gap-6 lg:grid-cols-3">
    <div class="lg:col-span-2 rounded-xl border border-base-300/50 bg-base-200/5 p-5">
      <div class="flex items-center gap-2 mb-4">
  <span id="dev-spin" class="loading loading-spinner loading-xs hidden"></span>
  <span class="text-sm opacity-60">Listado de cajas activas. Procesa la devolución: si el cronómetro tiene &gt;50% restante vuelve a Acondicionamiento (Lista para Despacho); si no, va a Inspección.</span>
      </div>
      <div id="dev-caja-grid" class="grid gap-4 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4"></div>
      <div class="mt-6">
        <h3 class="text-xs font-semibold tracking-wide uppercase opacity-60 mb-2">Resumen por Orden</h3>
        <div id="dev-orden-resumen" class="flex flex-wrap gap-2 text-[11px]">
          <!-- dinámico -->
        </div>
      </div>
    </div>
    <div class="rounded-xl border border-base-300/50 bg-base-200/5 p-5 flex flex-col gap-4">
      <h2 class="text-sm font-semibold tracking-wide uppercase opacity-80">Identificar Caja</h2>
      <div class="form-control">
        <label class="label py-1"><span class="label-text text-xs opacity-70">Escanea un RFID (24 caracteres)</span></label>
        <input id="dev-scan" type="text" maxlength="24" class="input input-sm input-bordered font-mono" placeholder="RFID 24" autocomplete="off" />
      </div>
      <div class="flex gap-2">
        <button id="dev-scan-btn" class="btn btn-sm btn-primary flex-1">Buscar</button>
        <button id="dev-scan-clear" class="btn btn-sm">Limpiar</button>
      </div>
      <div id="dev-scan-msg" class="text-xs min-h-[18px] font-mono opacity-80"></div>
      <div id="dev-scan-result" class="space-y-3 hidden">
        <div class="text-xs opacity-60 uppercase tracking-wide">Caja detectada</div>
        <div class="border rounded-lg p-3 bg-base-300/10 space-y-2" id="dev-scan-card"></div>
        <div class="text-[10px] opacity-50" id="dev-scan-extra"></div>
      </div>
    </div>
  </div>
</div>
<!-- Modal Detalle Caja -->
<dialog id="dev-modal" class="modal">
  <div class="modal-box max-w-sm p-5 space-y-4">
    <h3 class="font-semibold text-sm" id="dev-modal-title">Caja</h3>
    <div id="dev-modal-body" class="space-y-3 text-xs"></div>
    <div class="flex gap-2 pt-2">
  <button id="dev-modal-return" class="btn btn-primary btn-sm flex-1">➜ Procesar devolución</button>
      <button id="dev-modal-close" class="btn btn-sm">Cerrar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Cerrar</button>
  </form>
</dialog>
<!-- Diálogo de decisión -->
<dialog id="dev-decide" class="modal">
  <div class="modal-box max-w-sm p-5 space-y-3 relative">
    <button id="dev-decide-close" class="btn btn-xs btn-circle btn-ghost absolute right-3 top-3" title="Cerrar">✕</button>
    <h3 class="font-semibold text-sm pr-8">Procesar devolución</h3>
    <p id="dev-decide-msg" class="text-xs opacity-80"></p>
    <div class="grid gap-2 text-xs">
      <label class="form-control gap-1">
        <span class="label-text text-[11px] opacity-70">Zona destino (opcional)</span>
        <select id="dev-zona" class="select select-sm select-bordered"></select>
      </label>
      <label class="form-control gap-1">
        <span class="label-text text-[11px] opacity-70">Sección destino (opcional)</span>
        <select id="dev-seccion" class="select select-sm select-bordered" disabled>
          <option value="">Sin sección</option>
        </select>
      </label>
      <p id="dev-location-hint" class="text-[11px] opacity-70 min-h-[16px]"></p>
    </div>
    <div class="flex gap-2 pt-2" id="dev-decide-actions">
      <!-- botones dinámicos -->
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Cancelar</button>
  </form>
</dialog>
<!-- Modal: Cronómetro para En bodega · Pendiente a Inspección -->
<dialog id="dev-pi-timer" class="modal">
  <div class="modal-box max-w-sm p-5 space-y-3">
    <h3 class="font-semibold text-sm">Asignar cronómetro (Pendiente a Inspección)</h3>
    <div class="grid grid-cols-2 gap-2 text-sm">
      <label class="form-control">
        <span class="label-text text-xs opacity-70">Horas</span>
        <input id="dev-pi-hours" type="number" min="0" class="input input-sm input-bordered" placeholder="0" />
      </label>
      <label class="form-control">
        <span class="label-text text-xs opacity-70">Minutos</span>
        <input id="dev-pi-mins" type="number" min="0" class="input input-sm input-bordered" placeholder="0" />
      </label>
    </div>
    <div class="grid gap-2 text-xs">
      <label class="form-control gap-1">
        <span class="label-text text-[11px] opacity-70">Zona destino (opcional)</span>
        <select id="dev-pi-zona" class="select select-sm select-bordered"></select>
      </label>
      <label class="form-control gap-1">
        <span class="label-text text-[11px] opacity-70">Sección destino (opcional)</span>
        <select id="dev-pi-seccion" class="select select-sm select-bordered" disabled>
          <option value="">Sin sección</option>
        </select>
      </label>
      <p id="dev-pi-location-hint" class="text-[11px] opacity-70 min-h-[16px]"></p>
    </div>
    <div class="text-[11px] opacity-70">Se moverá la caja a "En bodega · Pendiente a Inspección" solo al aceptar.</div>
    <div class="flex gap-2 pt-2">
      <button id="dev-pi-accept" class="btn btn-sm btn-primary flex-1">Aceptar</button>
      <button id="dev-pi-cancel" class="btn btn-sm">Cancelar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop"><button>Cancelar</button></form>
</dialog>
<script src="/static/js/location-selector.js?v=<%= assetVersion %>" defer></script>
<script src="/static/js/devolucion.js?v=<%= assetVersion %>" defer></script>
