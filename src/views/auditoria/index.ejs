<div class="max-w-3xl mx-auto">
  <h1 class="text-xl font-semibold mb-4">Auditoría</h1>

  <form method="get" class="card bg-base-200/50 border border-base-300/40 mb-4">
    <div class="card-body grid grid-cols-1 md:grid-cols-3 gap-3">
      <div class="form-control md:col-span-2">
        <div class="label"><span class="label-text">Escanee o escriba el RFID</span></div>
  <input autofocus name="q" value="<%= (typeof item !== 'undefined' && item && item.rfid) ? item.rfid : '' %>" class="input input-bordered input-md font-mono" placeholder="XXXXXXXXXXXXXXXXXXXXXXXX" maxlength="24" autocomplete="off" data-rfid-input />
      </div>
      <div class="flex items-end">
        <button type="submit" class="btn btn-primary">Buscar</button>
      </div>
    </div>
  </form>

  <% if (error) { %>
    <div class="alert alert-error mb-4"><span><%= error %></span></div>
  <% } %>

  <% if (item) { %>
    <div class="card bg-base-200/50 border border-base-300/40 mb-4">
      <div class="card-body">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <div class="text-sm opacity-70">RFID</div>
            <div class="font-mono"><%= item.rfid || '-' %></div>
          </div>
          <div>
            <div class="text-sm opacity-70">Lote</div>
            <div><%= item.lote || '-' %></div>
          </div>
          <div>
            <div class="text-sm opacity-70">Orden</div>
            <div><%= item.numero_orden || '-' %></div>
          </div>
          <div>
            <div class="text-sm opacity-70">Estado</div>
            <div><%= [item.estado,item.sub_estado].filter(Boolean).join('/') || '-' %></div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card bg-base-200/50 border border-base-300/40">
        <div class="card-body">
          <h3 class="font-semibold mb-2">Auditar</h3>
          <form method="post" action="/auditoria/auditar-rfid" class="space-y-3">
            <input type="hidden" name="rfid" value="<%= item.rfid %>" />
            <div class="form-control">
              <label class="label"><span class="label-text">Estado auditoría</span></label>
              <select name="auditada" class="select select-bordered select-sm">
                <option value="true" <%= (audit && audit.auditada) ? 'selected' : '' %>>Auditada</option>
                <option value="false" <%= (audit && !audit.auditada) ? 'selected' : '' %>>Pendiente</option>
              </select>
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">Comentarios</span></label>
              <input type="text" name="comentarios" class="input input-bordered input-sm" maxlength="2000" value="<%= (audit && audit.comentarios) || '' %>" />
            </div>
            <div class="flex gap-2">
              <button type="submit" class="btn btn-primary">Guardar auditoría</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card bg-base-200/50 border border-base-300/40">
        <div class="card-body">
          <h3 class="font-semibold mb-2">Inhabilitar</h3>
          <form method="post" action="/auditoria/inhabilitar" class="space-y-3">
            <input type="hidden" name="rfid" value="<%= item.rfid %>" />
            <div class="form-control">
              <label class="label"><span class="label-text">Motivo</span></label>
              <input type="text" name="motivo" class="input input-bordered input-sm" maxlength="200" required />
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">Descripción (opcional)</span></label>
              <input type="text" name="descripcion" class="input input-bordered input-sm" maxlength="2000" />
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">Severidad</span></label>
              <input type="number" name="severidad" class="input input-bordered input-sm" min="1" max="5" value="3" />
            </div>
            <div class="flex gap-2">
              <button type="submit" class="btn btn-error">Inhabilitar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  <% } %>

  <div class="card bg-base-200/50 border border-base-300/40 overflow-x-auto mt-6">
    <div class="card-body p-0">
      <table class="table table-zebra table-sm w-full">
        <thead>
          <tr>
            <th class="whitespace-nowrap">Fecha</th>
            <th>RFID</th>
            <th>Lote</th>
            <th class="whitespace-nowrap">Orden</th>
            <th class="whitespace-nowrap">Estado</th>
            <th class="whitespace-nowrap">Novedad</th>
            <th>Comentarios</th>
            <th class="text-center">Auditada</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% if (items && items.length) { %>
            <% items.forEach(row => { %>
              <tr>
                <td class="text-xs whitespace-nowrap opacity-80"><%= new Date(row.fecha).toLocaleString() %></td>
                <td class="font-mono text-xs"><%= row.rfid || '-' %></td>
                <td class="text-xs"><%= row.lote || '-' %></td>
                <td class="text-xs"><%= row.numero_orden || '-' %></td>
                <td class="text-xs"><%= [row.estado,row.sub_estado].filter(Boolean).join('/') || '-' %></td>
                <td class="text-xs">
                  <% if (row.nov_tipo) { %>
                    <div><span class="opacity-70"><%= row.nov_tipo %></span> <%= row.nov_severidad?('('+row.nov_severidad+')'):'' %></div>
                    <div class="opacity-80 truncate max-w-[240px]" title="<%= row.nov_descripcion || '' %>"><%= row.nov_descripcion || '' %></div>
                    <% if (row.nov_inhabilita) { %><div class="badge badge-error badge-xs mt-1">Inhabilita</div><% } %>
                  <% } else { %>
                    -
                  <% } %>
                </td>
                <td class="text-xs align-top">
                  <%= row.comentarios || '-' %>
                </td>
                <td class="text-center">
                  <% if (row.auditada) { %>
                    <span class="badge badge-success badge-sm">Auditada</span>
                  <% } else { %>
                    <span class="badge badge-warning badge-sm">Pendiente</span>
                  <% } %>
                </td>
                <td class="text-center">
                  <div class="flex items-center justify-end gap-2">
                    <button type="button" class="btn btn-ghost btn-xs" data-action="aud-edit" data-id="<%= row.id %>" data-auditada="<%= row.auditada ? 'true' : 'false' %>" data-comentarios="<%= row.comentarios||'' %>">Editar</button>
                    <form method="post" action="/auditoria/<%= row.id %>/delete" data-action="aud-delete">
                      <button type="submit" class="btn btn-error btn-xs">Eliminar</button>
                    </form>
                  </div>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr><td colspan="9" class="text-center py-6 opacity-70">No hay registros</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal Editar Auditoría -->
  <dialog id="aud-edit-modal" class="modal">
    <div class="modal-box">
      <h3 class="font-semibold mb-3">Editar auditoría</h3>
      <form id="aud-edit-form" method="post" action="/auditoria/0/update" class="space-y-3">
        <div class="form-control">
          <label class="label"><span class="label-text">Estado auditoría</span></label>
          <select name="auditada" id="aud-edit-auditada" class="select select-bordered select-sm">
            <option value="false">Pendiente</option>
            <option value="true">Auditada</option>
          </select>
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Comentarios</span></label>
          <input type="text" name="comentarios" id="aud-edit-comentarios" class="input input-bordered input-sm" maxlength="2000" placeholder="Comentario" />
        </div>
        <div class="modal-action">
          <button type="button" class="btn" data-close>Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar cambios</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <script src="/static/js/auditoria.js?v=<%= assetVersion %>" defer></script>
  <script>
    (function(){
      const el = document.querySelector('[data-rfid-input]');
      if(!el) return;
      const MAX = 24;
      function clamp(){ if(el.value.length > MAX) el.value = el.value.slice(0, MAX); }
      el.addEventListener('input', clamp);
      el.addEventListener('paste', function(){ requestAnimationFrame(clamp); });
      clamp();
    })();
  </script>
</div>
