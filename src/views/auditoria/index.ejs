<div class="max-w-7xl mx-auto">
  <div class="mb-4 flex items-center justify-between">
    <h1 class="text-xl font-semibold">Auditoría</h1>
  </div>

  <form method="get" class="card bg-base-200/50 border border-base-300/40 mb-4">
    <div class="card-body grid grid-cols-1 md:grid-cols-5 gap-3">
      <div class="form-control w-full">
        <div class="label"><span class="label-text">Buscar (RFID/Lote/Orden)</span></div>
        <label class="input input-bordered input-sm flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
          <input type="search" name="q" id="aud-search-input" value="<%= q||'' %>" class="grow" placeholder="Ej: 777..., TICS-..., ORDEN-..." maxlength="40" autocomplete="off" />
        </label>
      </div>
      <label class="form-control">
        <div class="label"><span class="label-text">Desde</span></div>
        <input type="date" name="from" value="<%= fromDate||'' %>" class="input input-bordered input-sm" />
      </label>
      <label class="form-control">
        <div class="label"><span class="label-text">Hasta</span></div>
        <input type="date" name="to" value="<%= toDate||'' %>" class="input input-bordered input-sm" />
      </label>
      <label class="form-control">
        <div class="label"><span class="label-text">Estado auditoría</span></div>
        <select name="auditada" class="select select-bordered select-sm">
          <option value="" <%= (auditada===null?'selected':'') %>>Todos</option>
          <option value="false" <%= (auditada===false?'selected':'') %>>Pendiente</option>
          <option value="true" <%= (auditada===true?'selected':'') %>>Auditada</option>
        </select>
      </label>
      <div class="flex items-end">
        <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
      </div>
    </div>
  </form>

  <div class="card bg-base-200/50 border border-base-300/40 overflow-x-auto">
    <div class="card-body p-0">
      <table class="table table-zebra table-sm w-full">
        <thead>
          <tr>
            <th class="whitespace-nowrap">Fecha</th>
            <th>RFID</th>
            <th>Lote</th>
            <th class="whitespace-nowrap">Orden</th>
            <th class="whitespace-nowrap">Estado</th>
            <th class="whitespace-nowrap">Novedad</th>
            <th>Comentarios</th>
            <th class="text-center">Auditada</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% if (items && items.length) { %>
            <% items.forEach(row => { %>
              <tr>
                <td class="text-xs whitespace-nowrap opacity-80"><%= new Date(row.fecha).toLocaleString() %></td>
                <td class="font-mono text-xs"><%= row.rfid || '-' %></td>
                <td class="text-xs"><%= row.lote || '-' %></td>
                <td class="text-xs"><%= row.numero_orden || '-' %></td>
                <td class="text-xs"><%= [row.estado,row.sub_estado].filter(Boolean).join('/') || '-' %></td>
                <td class="text-xs">
                  <% if (row.nov_tipo) { %>
                    <div><span class="opacity-70"><%= row.nov_tipo %></span> <%= row.nov_severidad?('('+row.nov_severidad+')'):'' %></div>
                    <div class="opacity-80 truncate max-w-[240px]" title="<%= row.nov_descripcion || '' %>"><%= row.nov_descripcion || '' %></div>
                    <% if (row.nov_inhabilita) { %><div class="badge badge-error badge-xs mt-1">Inhabilita</div><% } %>
                  <% } else { %>
                    -
                  <% } %>
                </td>
                <td class="text-xs align-top">
                  <%= row.comentarios || '-' %>
                </td>
                <td class="text-center">
                  <% if (row.auditada) { %>
                    <span class="badge badge-success badge-sm">Auditada</span>
                  <% } else { %>
                    <span class="badge badge-warning badge-sm">Pendiente</span>
                  <% } %>
                </td>
                <td class="text-center">
                  <div class="flex items-center justify-end gap-2">
                    <button type="button" class="btn btn-ghost btn-xs" data-action="aud-edit" data-id="<%= row.id %>" data-auditada="<%= row.auditada ? 'true' : 'false' %>" data-comentarios="<%= row.comentarios||'' %>">Editar</button>
                    <form method="post" action="/auditoria/<%= row.id %>/delete" data-action="aud-delete">
                      <button type="submit" class="btn btn-error btn-xs">Eliminar</button>
                    </form>
                  </div>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr><td colspan="9" class="text-center py-6 opacity-70">No hay registros</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Editar Auditoría -->
<dialog id="aud-edit-modal" class="modal">
  <div class="modal-box">
    <h3 class="font-semibold mb-3">Editar auditoría</h3>
    <form id="aud-edit-form" method="post" action="/auditoria/0/update" class="space-y-3">
      <div class="form-control">
        <label class="label"><span class="label-text">Estado auditoría</span></label>
        <select name="auditada" id="aud-edit-auditada" class="select select-bordered select-sm">
          <option value="false">Pendiente</option>
          <option value="true">Auditada</option>
        </select>
      </div>
      <div class="form-control">
        <label class="label"><span class="label-text">Comentarios</span></label>
        <input type="text" name="comentarios" id="aud-edit-comentarios" class="input input-bordered input-sm" maxlength="2000" placeholder="Comentario" />
      </div>
      <div class="modal-action">
        <button type="button" class="btn" data-close>Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar cambios</button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop"><button>close</button></form>
  
</dialog>

<script src="/static/js/auditoria.js?v=<%= assetVersion %>" defer></script>
