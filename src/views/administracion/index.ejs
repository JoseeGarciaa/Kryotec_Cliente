<% title = title || 'Administraci√≥n' %>
<div class="space-y-6">
  <% const availableRoles = [
    { value: 'acondicionador', label: 'Acondicionador' },
    { value: 'operador', label: 'Operador' },
    { value: 'bodeguero', label: 'Bodeguero' },
    { value: 'inspeccionador', label: 'Inspeccionador' },
    { value: 'admin', label: 'Admin' },
    { value: 'super_admin', label: 'Super admin' }
  ]; %>
  <% if (flash && flash.ok) { %>
    <div class="alert alert-success shadow"><span><%= flash.ok %></span></div>
  <% } %>
  <% if (flash && flash.error) { %>
    <div class="alert alert-error shadow"><span><%= flash.error %></span></div>
  <% } %>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="stat bg-base-200 rounded-box">
      <div class="stat-title">Usuarios Totales</div>
      <div class="stat-value text-primary"><%= total %></div>
    </div>
    <div class="stat bg-base-200 rounded-box">
      <div class="stat-title">Usuarios Activos</div>
      <div class="stat-value text-success"><%= activos %></div>
    </div>
    <div class="stat bg-base-200 rounded-box">
      <div class="stat-title">Usuarios Inactivos</div>
      <div class="stat-value text-error"><%= inactivos %></div>
    </div>
  </div>

  <div class="card bg-base-200">
    <div class="card-body">
      <div class="flex items-center justify-between mb-2">
        <h2 class="card-title">Sedes</h2>
        <div class="flex items-center gap-2">
          <a href="/administracion/zonas" class="btn btn-primary btn-sm">Zonas y secciones</a>
          <button id="btn-new-sede" class="btn btn-secondary btn-sm">+ Nueva Sede</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="table table-zebra table-sm">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>C√≥digo</th>
              <th>Estado</th>
              <th class="text-right">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% if ((sedes || []).length === 0) { %>
              <tr>
                <td colspan="3" class="text-center text-sm opacity-60">No hay sedes registradas.</td>
              </tr>
            <% } else { %>
              <% sedes.forEach(s => { %>
                <% const sedeNombreAttr = (s.nombre || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;'); %>
                <% const sedeCodigoAttr = ((s.codigo || '')).replace(/"/g, '&quot;').replace(/'/g, '&#39;'); %>
                <tr>
                  <td><span class="font-semibold"><%= s.nombre %></span></td>
                  <td class="text-sm"><%= s.codigo || '-' %></td>
                  <td>
                    <span class="badge badge-outline <%= s.activo === false ? 'badge-error' : 'badge-success' %>">
                      <%= s.activo === false ? 'Inactiva' : 'Activa' %>
                    </span>
                  </td>
                  <td>
                    <div class="flex justify-end gap-1">
                      <button
                        type="button"
                        class="btn btn-ghost btn-xs btn-edit-sede"
                        title="Editar sede"
                        data-id="<%= s.sede_id %>"
                        data-nombre="<%- sedeNombreAttr %>"
                        data-codigo="<%- sedeCodigoAttr %>"
                        data-activo="<%= s.activo === false ? 'false' : 'true' %>"
                      >‚úèÔ∏è</button>
                      <button
                        type="button"
                        class="btn btn-ghost btn-xs text-error btn-del-sede"
                        title="Eliminar sede"
                        data-id="<%= s.sede_id %>"
                        data-nombre="<%- sedeNombreAttr %>"
                      >üóëÔ∏è</button>
                    </div>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card bg-base-200">
    <div class="card-body">
      <div class="flex items-center justify-between mb-2">
        <h2 class="card-title">Gesti√≥n de Usuarios</h2>
  <button id="btn-new-user" class="btn btn-primary btn-sm">+ Nuevo Usuario</button>
      </div>
      <div class="overflow-x-auto">
        <table class="table table-zebra table-sm">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Tel√©fono</th>
              <th>Rol</th>
              <th>Sede</th>
              <th>TTL sesi√≥n (min)</th>
              <th>Estado</th>
              <th>√öltimo acceso</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% users.forEach(u => { %>
              <tr>
                <td>
                  <div class="flex items-center gap-2">
                    <div class="avatar placeholder">
                      <div class="bg-primary text-primary-content rounded-full w-8"><span><%= (u.nombre||'?')[0].toUpperCase() %></span></div>
                    </div>
                    <div>
                      <div class="font-semibold text-sm leading-tight"><%= u.nombre %></div>
                      <div class="text-xs opacity-70"><%= u.correo %></div>
                    </div>
                  </div>
                </td>
                <td class="text-xs"><%= u.telefono || '-' %></td>
                <td>
                  <% const roleFriendly = {
                    super_admin: 'Super Admin',
                    admin: 'Admin',
                    acondicionador: 'Acondicionador',
                    operador: 'Operador',
                    bodeguero: 'Bodeguero',
                    inspeccionador: 'Inspeccionador'
                  }; %>
                  <% const roleLegacyMap = {
                    preacond: 'acondicionador',
                    'preacondicionador': 'acondicionador',
                    operacion: 'operador',
                    operador: 'operador',
                    bodega: 'bodeguero',
                    inspeccion: 'inspeccionador',
                    administrador: 'admin',
                    superadmin: 'super_admin',
                    'super-admin': 'super_admin',
                    'super administrador': 'super_admin'
                  }; %>
                  <% const roleValues = Array.isArray(u.roles) && u.roles.length ? u.roles : (u.rol ? [u.rol] : []); %>
                  <% const normalizedRoles = []; const seenRoles = new Set(); %>
                  <% roleValues.forEach((value) => {
                       const key = (value || '').toString().toLowerCase();
                       const canonical = roleLegacyMap[key] || key;
                       if (!seenRoles.has(canonical)) { seenRoles.add(canonical); normalizedRoles.push(canonical); }
                     }); %>
                  <% if (!normalizedRoles.length && u.rol) normalizedRoles.push((roleLegacyMap[(u.rol || '').toLowerCase()] || (u.rol || '')).toLowerCase()); %>
                  <% normalizedRoles.forEach((canonical) => { const label = roleFriendly[canonical] || canonical; const tone = (canonical === 'admin' || canonical === 'super_admin') ? 'badge-primary' : 'badge-outline'; %>
                    <span class="badge <%= tone %> mr-1"><%= label %></span>
                  <% }) %>
                </td>
                <td>
                  <% const hasSede = !(u.sede_id === null || u.sede_id === undefined || u.sede_id === ''); %>
                  <span class="badge badge-ghost text-xs"><%= hasSede ? (u.sede_nombre || ('ID '+u.sede_id)) : 'Todas las sedes' %></span>
                </td>
                <td class="text-xs"><%= u.sesion_ttl_minutos || sessionTtlDefault %></td>
                <td>
                  <button
                    type="button"
                    class="btn-toggle-activo inline-flex items-center gap-2 rounded-full border px-3 py-1 text-xs font-semibold transition-colors <%= u.activo
                      ? 'border-emerald-500/30 bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500/20'
                      : 'border-rose-500/40 bg-rose-500/10 text-rose-400 hover:bg-rose-500/20'
                    %>"
                    data-id="<%= u.id %>"
                    data-next="<%= u.activo ? 'false' : 'true' %>"
                    data-nombre="<%- u.nombre %>"
                  >
                    <span class="h-2.5 w-2.5 rounded-full <%= u.activo ? 'bg-emerald-400' : 'bg-rose-400' %>"></span>
                    <span><%= u.activo ? 'Activo' : 'Inactivo' %></span>
                  </button>
                </td>
                <td class="text-xs"><%= u.ultimo_ingreso ? new Date(u.ultimo_ingreso).toLocaleString('es-CO') : '-' %></td>
                <td class="flex gap-1">
      <button class="btn btn-ghost btn-xs btn-edit-user" 
        data-id="<%= u.id %>" 
        data-nombre="<%- u.nombre %>" 
        data-correo="<%- u.correo %>" 
        data-telefono="<%- u.telefono || '' %>" 
        data-rol="<%- u.rol %>" 
        data-roles='<%- JSON.stringify(Array.isArray(u.roles) && u.roles.length ? u.roles : (u.rol ? [u.rol] : [])) %>'
        data-sede="<%= u.sede_id || '' %>" 
        data-activo="<%= u.activo ? 'true' : 'false' %>"
        data-ttl="<%= u.sesion_ttl_minutos || sessionTtlDefault %>">‚úèÔ∏è</button>
  <button class="btn btn-ghost btn-xs text-error btn-del-user" title="Inhabilitar usuario" aria-label="Inhabilitar usuario" data-id="<%= u.id %>">üóëÔ∏è</button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<dialog id="dlg-new-sede" class="modal">
  <div class="modal-box">
    <form method="post" action="/administracion/sedes" class="space-y-3">
      <h3 class="font-bold text-lg">Nueva Sede</h3>
      <input required name="nombre" placeholder="Nombre" class="input input-sm input-bordered w-full" />
      <input name="codigo" placeholder="C√≥digo" class="input input-sm input-bordered w-full" />
      <select name="activa" class="select select-sm select-bordered w-full">
        <option value="true" selected>Activa</option>
        <option value="false">Inactiva</option>
      </select>
      <div class="modal-action">
        <button type="submit" class="btn btn-secondary btn-sm">Guardar</button>
        <button type="button" class="btn btn-sm btn-close-modal" data-target="dlg-new-sede">Cerrar</button>
      </div>
    </form>
  </div>
</dialog>

<dialog id="dlg-edit-sede" class="modal">
  <div class="modal-box">
    <form id="form-edit-sede" method="post" class="space-y-3">
      <h3 class="font-bold text-lg">Editar Sede</h3>
      <input required name="nombre" placeholder="Nombre" class="input input-sm input-bordered w-full" />
      <input name="codigo" placeholder="C√≥digo" class="input input-sm input-bordered w-full" />
      <select name="activa" class="select select-sm select-bordered w-full">
        <option value="true">Activa</option>
        <option value="false">Inactiva</option>
      </select>
      <div class="modal-action">
        <button type="submit" class="btn btn-primary btn-sm">Guardar cambios</button>
        <button type="button" class="btn btn-sm btn-close-modal" data-target="dlg-edit-sede">Cerrar</button>
      </div>
    </form>
  </div>
</dialog>

<dialog id="dlg-new-user" class="modal">
  <div class="modal-box">
    <form method="post" action="/administracion/nuevo" class="space-y-3">
      <h3 class="font-bold text-lg">Nuevo Usuario</h3>
      <input required name="nombre" placeholder="Nombre" class="input input-sm input-bordered w-full" />
      <input required name="correo" type="email" placeholder="Correo" class="input input-sm input-bordered w-full" />
      <input name="telefono" placeholder="Tel√©fono" class="input input-sm input-bordered w-full" />
      <label class="form-control">
        <span class="label-text text-xs opacity-70">Contrase√±a inicial</span>
        <div class="flex items-center gap-2">
          <input id="admin-new-password" required name="password" type="password" placeholder="Contrase√±a inicial" class="input input-sm input-bordered flex-1" minlength="8" autocomplete="new-password" />
          <button type="button" class="btn btn-xs btn-outline btn-circle" data-password-toggle="admin-new-password" aria-label="Mostrar u ocultar contrase√±a" aria-pressed="false">
            <span class="inline-flex h-4 w-4 items-center justify-center" data-eye-icon></span>
          </button>
        </div>
      </label>
      <p class="text-xs opacity-70"><%= passwordPolicy %></p>
      <label class="form-control">
        <span class="label-text text-xs opacity-70">Roles</span>
        <select name="roles" id="new-user-roles" class="select select-sm select-bordered w-full" multiple size="6">
          <% availableRoles.forEach((opt) => { %>
            <option value="<%= opt.value %>" <%= opt.value === 'acondicionador' ? 'selected' : '' %>><%= opt.label %></option>
          <% }) %>
        </select>
        <span class="text-[11px] opacity-60">Selecciona uno o varios roles (Ctrl/‚åò + clic para combinar).</span>
      </label>
      <select name="sede_id" class="select select-sm select-bordered w-full">
        <option value="">Sin sede</option>
        <% (sedes || []).forEach(s => { %>
          <option value="<%= s.sede_id %>"><%= s.nombre %></option>
        <% }) %>
      </select>
      <label class="form-control">
        <span class="label-text">Tiempo de sesi√≥n (minutos)</span>
        <input name="sesion_ttl_minutos" type="number" min="<%= sessionTtlMin %>" max="<%= sessionTtlMax %>" value="<%= sessionTtlDefault %>" class="input input-sm input-bordered w-full" required />
      </label>
      <div class="modal-action">
        <button type="submit" class="btn btn-primary btn-sm">Guardar</button>
  <button type="button" class="btn btn-sm btn-close-modal" data-target="dlg-new-user">Cerrar</button>
      </div>
    </form>
  </div>
</dialog>

<dialog id="dlg-edit-user" class="modal">
  <div class="modal-box">
    <form id="form-edit" method="post" class="space-y-3" data-ttl-min="<%= sessionTtlMin %>" data-ttl-max="<%= sessionTtlMax %>">
      <h3 class="font-bold text-lg">Editar Usuario</h3>
      <input required name="nombre" placeholder="Nombre" class="input input-sm input-bordered w-full" />
      <input required name="correo" type="email" placeholder="Correo" class="input input-sm input-bordered w-full" />
      <input name="telefono" placeholder="Tel√©fono" class="input input-sm input-bordered w-full" />
      <label class="form-control">
        <span class="label-text text-xs opacity-70">Contrase√±a (dejar vac√≠o para no cambiar)</span>
        <div class="flex items-center gap-2">
          <input id="admin-edit-password" name="password" type="password" placeholder="Password (dejar vac√≠o para no cambiar)" class="input input-sm input-bordered flex-1" minlength="8" autocomplete="new-password" />
          <button type="button" class="btn btn-xs btn-outline btn-circle" data-password-toggle="admin-edit-password" aria-label="Mostrar u ocultar contrase√±a" aria-pressed="false">
            <span class="inline-flex h-4 w-4 items-center justify-center" data-eye-icon></span>
          </button>
        </div>
      </label>
      <label class="form-control">
        <span class="label-text text-xs opacity-70">Roles</span>
        <select name="roles" id="edit-user-roles" class="select select-sm select-bordered w-full" multiple size="6">
          <% availableRoles.forEach((opt) => { %>
            <option value="<%= opt.value %>"><%= opt.label %></option>
          <% }) %>
        </select>
        <span class="text-[11px] opacity-60">Selecciona uno o varios roles.</span>
      </label>
      <select name="sede_id" class="select select-sm select-bordered w-full">
        <option value="">Sin sede</option>
        <% (sedes || []).forEach(s => { %>
          <option value="<%= s.sede_id %>"><%= s.nombre %></option>
        <% }) %>
      </select>
      <select name="activo" class="select select-sm select-bordered w-full">
        <option value="true">Activo</option>
        <option value="false">Inactivo</option>
      </select>
      <label class="form-control">
        <span class="label-text">Tiempo de sesi√≥n (minutos)</span>
        <input name="sesion_ttl_minutos" type="number" min="<%= sessionTtlMin %>" max="<%= sessionTtlMax %>" class="input input-sm input-bordered w-full" />
      </label>
      <div class="modal-action">
        <button type="submit" class="btn btn-primary btn-sm">Guardar</button>
  <button type="button" class="btn btn-sm btn-close-modal" data-target="dlg-edit-user">Cerrar</button>
      </div>
    </form>
  </div>
</dialog>
<script src="/static/js/password-visibility.js?v=<%= assetVersion %>" defer></script>
<script src="/static/js/administracion.js?v=<%= assetVersion %>" defer></script>
